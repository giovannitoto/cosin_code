# cosin_code

This repository contains the R code developed and used in the paper:

Structured factorization for single-cell gene expression data

## `cosin` package

The *R* code uses the [cosin](https://github.com/giovannitoto/cosin) package which implements COunt data Structured INfinite factorization (COSIN). To install the package (in *R*):
```{r}
# if devtools is not installed yet:
# install.packages("devtools")
library(devtools)
install_github("giovannitoto/cosin")
```

## Contents

The repository includes the following files and folders:

- [data](https://github.com/giovannitoto/cosin_code/tree/main/data) contains files related to CITE-Seq Cord Blood data and lung adenocarcinoma scRNA-seq data;

- [results](https://github.com/giovannitoto/cosin_code/tree/main/results) contains files related to COSIN applied to CITE-Seq Cord Blood data and lung adenocarcinoma scRNA-seq data;

- [simulations](https://github.com/giovannitoto/cosin_code/tree/main/simulations) contains files generated by `simulations_*.R` files;

- [src/metrics.R](https://github.com/giovannitoto/cosin_code/tree/main/src/metrics.R) contains functions used to evaluate the models estimated on synthetic data sets;

- [src/aglmpca.R](https://github.com/giovannitoto/cosin_code/tree/main/src/aglmpca.R) contains an implementation of GLM-PCA approximation proposed by Townes et al. (2019);

- `simulations_*` are R files related to simulations; see *Simulations* section below.

- [CITESeqCordBlood_preprocessing.R](https://github.com/giovannitoto/cosin_code/tree/main/CITESeqCordBlood_preprocessing.R) and [CITESeqCordBlood_mcmc.R](https://github.com/giovannitoto/cosin_code/tree/main/CITESeqCordBlood_mcmc.R) contain the code developed and used to preprocess the CITE-Seq Cord Blood data and estimate COSIN on it, respectively.

- [CITESeqCordBlood.Rmd](https://github.com/giovannitoto/cosin_code/tree/main/CITESeqCordBlood.Rmd) contains the code developed and used for the analysis of CITE-Seq Cord Blood data; [CITESeqCordBlood.pdf](https://github.com/giovannitoto/cosin_code/tree/main/CITESeqCordBlood.pdf) is the respective rendered file.

- [LungAdenocarcinomascRNAseq.Rmd](https://github.com/giovannitoto/cosin_code/tree/main/LungAdenocarcinomascRNAseq.Rmd) contains the code developed and used for the analysis of lung adenocarcinoma scRNA-seq data; [LungAdenocarcinomascRNAseq.pdf](https://github.com/giovannitoto/cosin_code/tree/main/LungAdenocarcinomascRNAseq.pdf) is the respective rendered file.

- [simulations.Rmd](https://github.com/giovannitoto/cosin_code/tree/main/simulations.Rmd) contains the code developed and used for computing the aggregated evaluation metrics of the simulation study; [simulations.pdf](https://github.com/giovannitoto/cosin_code/tree/main/simulations.pdf) is the respective rendered file.

## CITE-Seq Cord Blood data

we analyze the coord blood mononuclear cells (CBMCs) CITE-seq dataset. CITE-seq is a multi-modal protocol that allows the simultaneous measurement of gene expression by scRNA-Seq in addition to the expression of several protein surface markers in the same cells.
We use the data provided in the `SingleCellMultimodal` Bioconductor package, consisting of the expression of 36280 genes in 7858 cells, along with a cell-type label based on the surface markers, which we consider as ground truth.
We select the human genes available in the Ensembl database (v. 79) that are annotated as being part of the twenty immune system pathways in the KEGG database or in the remaining four largest pathways. We further remove genes with missing information about length and GC content.

The resulting data consist of a gene expression matrix of *n=7858* cells and *p=2587* genes.
Along with this gene expression matrix (`y`), quality control information about the cells (covariates `x`) and the genes (technical metacovariates `wT` and biological metacovariates `wB`) are also available.

Cell type information is available, but not to included as a covariate in the model.
This decision reflects a common scenario in scRNA-Seq analysis, where cell identities are unknown beforehand.
As a result, our setup provides a meaningful benchmark for evaluating the model’s ability to infer latent grouping structures in high-dimensional data.

See [CITESeqCordBlood.pdf](https://github.com/giovannitoto/cosin_code/tree/main/CITESeqCordBlood.pdf) for the code developed and used for the analysis of lung adenocarcinoma scRNA-seq data.


## Lung adenocarcinoma scRNA-seq data

We analyze a subset of a large study with scRNA-seq data for three lung adenocarcinoma cell lines (Tian et al., 2019). The original data are high quality in terms of exon mapping and unique transcript counts per cell. The data have already undergone post-sampling quality control. Pre-analysis of the data was performed by Tian et al. (2019) exploiting the pipe-line of pre-analysis for scRNA-seq data, `scPipe`. Cells with high percentages of mitochondrial genes and less than 1000 detected genes are excluded. The resulting data has a gene expression matrix of *n=199* cells and *p=949* genes. Along with this gene expression matrix (`y`), quality control information about the cells (`x`) and the genes (`wT`, `wB`) are also available.

See [LungAdenocarcinomascRNAseq.pdf](https://github.com/giovannitoto/cosin_code/tree/main/LungAdenocarcinomascRNAseq.pdf) for the code developed and used for the analysis of lung adenocarcinoma scRNA-seq data.


## Simulation study

To illustrate the validity and generality of COSIN, we assess its performances through a simulation study. As competitor, we use the generalized principal component analysis (or GLM-PCA, Townes et al., 2019), representing the current state-of-the-art in dimension reduction for sRNA-seq data.

We consider three scenarios in which *eta* and *lambda* have different sparsity structures.

#####  Data generation and COSIN estimation

`simulation_woNA.R` simulates the synthetic data sets without NAs and estimates COSIN with and without meta-covariates on them; `simulations_NA.R` simulates the synthetic data sets with NAs (25%) and estimates COSIN with and without meta-covariates on them.
We can launch the files from the command prompt as follows:
```
R --slave --no-restore --file=simulations_woNA.R
R --slave --no-restore --file=simulations_NA.R
```

##### COSIN evaluation

`simulations_NA_metrics.R` and `simulations_woNA_metrics.R` evaluate the synthetic data sets with and without NA values respectively.
Currently, the following evaluation metrics can be computed:

- metrics obtained comparing the original rank-one contributions and the contributions estimated by COSIN at each iteration:

  - Accuracy
  - F1
  - Mean Absolute Error (MAE)
  - Mean Square Error (MSE)
  - Precision
  - Root Mean Square Error (RMSE)
  - Sensitivity
  - Specificity


- metrics obtained comparing the original gene expression matrix and the matrix predicted by COSIN at each MCMC iteration:

  - Mean Absolute Deviation (MAD)
  - Mean Absolute Error (MAE)
  - Root Mean Square Error (RMSE)


We can launch the files from the command prompt as follows:
```
R --slave --no-restore --file=simulations_NA_metrics.R
R --slave --no-restore --file=simulations_woNA_metrics.R
```

For each scenario `<s>`, the metrics are grouped in a table in which each row corresponds to a synthetic data set and each column to an information related to the data set (`n`, `p`, `sigma`, `r`) or to an evaluation metric.
See [TABLES.md](https://github.com/giovannitoto/cosin_code/tree/main/TABLES.md) for the complete list of the columns and a description of the evaluation metrics which are currently implemented.

The tables generated by `simulations_NA_metrics.R` are saved as `table_metrics_nometa_woNA_p<p>_s<s>.RDS`, while the ones generated by `simulations_woNA_metrics.R` as `table_metrics_nometa_NA_p<p>_s<s>.RDS`.

##### GLM-PCA estimation and evaluation

First, `simulations_glmpca.R` estimates GLM-PCA with *k*=2,...,8 latent factors on the synthetic data sets with NAs and selects as benchmark the specification characterized by the lowest out-of-sample MAE. Then, since the available implementation of GLM-PCA does not work on data with NAs, we implemented the GLM-PCA approximation proposed by Townes et al. (2019), i.e. principal component analysis on Pearson residuals of the null Poisson model (see [src/aglmpca.R](https://github.com/giovannitoto/cosin_code/tree/main/src/aglmpca.R)).

We can launch the file from the command prompt as follows:
```
R --slave --no-restore --file=simulations_glmpca.R
```

For each scenario `<s>`, the metrics are grouped in a table in which each row corresponds to a synthetic data set and each column to an information related to the data set (`n`, `p`, `sigma`, `r`, `na_prop`) or to an evaluation metric.
See [TABLES.md](https://github.com/giovannitoto/cosin_code/tree/main/TABLES.md) for the complete list of the columns and a description of the evaluation metrics which are currently implemented.

The tables generated by `simulations_glmpca.R` are saved as `table_metrics_meta_s<s>.RDS` and `table_metrics_nometa_s<s>.RDS`.

##### Clustering of cells
`simulations_clustering.R` computes the Adjusted Rand Index (ARI) between the true cell groups and the groups obtained performing k-means on the latent dimensions of COSIN or its competitors.
Each competitor is estimated twice, using the true number of latent dimensions and using the number of principal components required to explain 90% of the variability in log-transformed counts as the number of latent factors.

Currently, the following competitors are evaluated:

- GLM-PCA (Townes et al., 2019)
- NewWave (Agostinis et al., 2022)
- PCA on log-transformed counts
- scGBM (Nicol and Miller, 2024)
- FAST-GLM-PCA (Weine et al., 2024)

We can launch the file from the command prompt as follows:
```
R --slave --no-restore --file=simulations_clustering.R
```

The metrics are grouped in a table in which each row corresponds to a synthetic data set and each column to an information related to the data set (`n`, `p`, `sigma`, `r`, `na_prop`) or to an ARI.
See [TABLES.md](https://github.com/giovannitoto/cosin_code/tree/main/TABLES.md) for the complete list of the columns.

The table generated by `simulations_clustering.R` is saved as `table_metric_clustering_kmeans.RDS`.


##### Tables of metrics

All tables generated in the previous steps are saved in [simulations/metrics](https://github.com/giovannitoto/cosin_code/tree/main/simulations/metrics).
See [simulations.pdf](https://github.com/giovannitoto/cosin_code/tree/main/simulations.pdf) for the code developed and used for computing the aggregated evaluation metrics.


## References

Agostinis, F., Romualdi, C., Sales, G. and Risso, D. (2022) Newwave: a scalable r/bioconductor package for the dimensionality reduction and batch effect removal of single-cell rna-seq data. *Bioinformatics*, **38**, 2648–2650.

Nicol, P. B. and Miller, J. W. (2024) Model-based dimensionality reduction for single-cell rna-seq using generalized bilinear models. *bioRxiv*, 2023–04.

Tian, L., Dong, X., Freytag, S., Lê Cao, K.-A., Su, S., JalalAbadi, A., Amann-Zalcenstein, D., Weber, T. S., Seidi, A., Jabbari, J. S., et al. (2019). Benchmarking single cell rna-sequencing analysis pipelines using mixture control experiments. *Nature methods* **16**, 479–487.

Townes, F. W., Hicks, S. C., Aryee, M. J., and Irizarry, R. A. (2019). Feature selection and dimension reduction for single-cell rna-seq based on a multinomial model. *Genome biology* **20**, 1–16.

Weine, E., Carbonetto, P. and Stephens, M. (2024) Accelerated dimensionality reduction of single-cell rna sequencing data with fastglmpca. *bioRxiv*.
